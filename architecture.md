# OpenDyslexia Chrome Extension - Architecture Overview

This document serves as the single source of truth for the **OpenDyslexia Chrome Extension**. It provides a comprehensive overview of the project's architecture, file structure, data flow, and development conventions. The goal is to enable any developer or AI agent to understand the codebase and make targeted changes efficiently.

## 1. High-Level Architecture

The extension follows a standard **Manifest V3** architecture, separating responsibilities into distinct components: a background service worker, content scripts, and UI pages (popup and options). Communication between these components is handled via asynchronous message passing.

### Core Technologies

-   **TypeScript**: Ensures type safety and improves code maintainability across the entire codebase.
-   **React**: Powers the interactive user interfaces for the popup and options pages.
-   **Vite**: A modern, fast build tool for development and production bundling.
-   **ESLint**: Enforces consistent code style and catches potential errors.

### Architectural Patterns & Data Flow

1.  **Centralized State Management**: The **Service Worker (`background.ts`)** is the central authority for all application state. It reads from and writes to `chrome.storage.local` and is the only component that directly modifies persisted settings.

2.  **Message-Driven Communication**: Components communicate using a defined set of messages (`chrome.runtime.sendMessage` and `chrome.tabs.sendMessage`). This decouples the components and ensures a predictable data flow.
    -   **Pull**: On page load, the **Content Script** sends a `GET_SETTINGS` message to the Service Worker to pull the correct styles for the current site.
    -   **Push**: When a user changes a setting in the **Popup** or **Options** page, the UI sends a message to the Service Worker, which then updates the storage and pushes the new styles to the relevant Content Script(s).

3.  **Dynamic CSS Injection**: The **Content Script (`content-script.ts`)** is responsible for injecting and managing a `<style>` element in the web page's `<head>`. The CSS content is programmatically generated by the `buildCss` function in `content/styles.ts`.

4.  **Resilient Content Modification**:
    -   A **`MutationObserver`** in the content script watches for dynamically added DOM nodes (e.g., in single-page apps) to ensure they are also styled correctly.
    -   A **`forceInlineOverrides`** function handles elements with high-specificity inline `style` attributes, ensuring the OpenDyslexic font is applied consistently.
    -   An **`isExcluded`** function prevents styling of sensitive elements like icons, code blocks, and math formulas.

5.  **Main World Bridge**: A `bridge.ts` script is injected into the page's main execution context. This allows the isolated content script to expose functionality (`applyStyles`, `updateStyles`, `removeStyles`) to the `window` object for debugging and potential future integrations.

## 2. Full Directory & File Structure

This section details every file and directory in the repository, explaining its purpose, key exports, dependencies, and role in the project.

### Root Directory: `OpenDyslexia_Chrome_Extension/`

-   **`architecture.md`**: **This file.** The single source of truth for the project's architecture, design patterns, and file structure.
-   **`eslint.config.js`**: Configures ESLint for static code analysis. It integrates TypeScript and React plugins to enforce coding standards and prevent common errors.
-   **`index.html`**: The main HTML entry point for the Vite development server. It is **not** part of the packaged extension but is used for local development and testing of the main `App.tsx` component.
-   **`package.json`**: Defines project metadata, dependencies (`react`, `react-dom`), development dependencies (`vite`, `typescript`, `eslint`), and scripts (`dev`, `build`, `lint`).
-   **`package-lock.json`**: Locks the exact versions of project dependencies to ensure reproducible builds.
-   **`tsconfig.json`**: The root TypeScript configuration file. It references the application-specific (`tsconfig.app.json`) and Node.js-specific (`tsconfig.node.json`) configurations.
-   **`tsconfig.app.json`**: TypeScript configuration for the frontend code (React components, content scripts). It includes settings for JSX, the DOM library, and module resolution.
-   **`tsconfig.node.json`**: TypeScript configuration for build scripts and configuration files that run in a Node.js environment (e.g., `vite.config.ts`).
-   **`vite.config.ts`**: Configures the Vite build system. It defines the entry points for the different parts of the extension (`background`, `content-script`, `popup`, `options`, `bridge`) and specifies how the output files should be named and organized in the `dist` directory.
-   **`README.md`**: General project information, setup instructions, and goals. Complements `architecture.md` with a higher-level project overview.
-   **`PRD_01.md`**: The Product Requirements Document, outlining the feature set, user personas, and acceptance criteria for the MVP.

### Public Assets: `public/`

This directory contains static assets that are copied directly to the `dist` build output without being processed by Vite.

-   **`fonts/`**: Contains the OpenDyslexic font files (`.woff2` format) which are declared as `web_accessible_resources` and injected into pages via CSS.
-   **`icons/`**: A placeholder for the extension's toolbar icons.
-   **`manifest.json`**: The core configuration file for the Chrome Extension. It defines permissions, scripts, the service worker, UI pages, and other metadata.
-   **`options.html`**: The HTML entry point for the React-based options page. It contains a `<div id="root">` where the `options.tsx` component is mounted.
-   **`popup.html`**: The HTML entry point for the React-based popup page. It contains a `<div id="root">` where the `Popup.tsx` component is mounted.
-   **`vite.svg`**: A sample SVG logo used in the default Vite project setup. Can be replaced with the extension's logo.

### Source Code: `src/`

This is the heart of the extension, containing all the TypeScript and React source code.

#### Core Scripts
-   **`background.ts`**: **Service Worker.** The central hub of the extension. It manages state, handles all browser events and messages, and communicates with other components.
    -   **Dependencies**: Uses `lib/storage.ts` for settings. Listens to `chrome.runtime.onMessage`, `chrome.commands.onCommand`, and `chrome.tabs.onUpdated`.
-   **`content-script.ts`**: **Content Script.** Injected into every web page. It applies the font styles, observes DOM changes, and communicates with the service worker to get settings.
    -   **Key Functions**: `applyStyles`, `updateStyles`, `removeStyles`, `isExcluded`, `forceInlineOverrides`
    -   **Dependencies**: Uses `content/styles.ts`. Communicates with `background.ts` via messaging. Injects and uses `bridge.ts`.
-   **`bridge.ts`**: **Main World Bridge.** Injected into the page's main JavaScript context to allow the content script to expose functionality for debugging or other purposes.
    -   **Key Exports**: `window.applyStyles`, `window.updateStyles`, `window.removeStyles`
    -   **Dependencies**: Injected by `content-script.ts`. Communicates back to the content script via `window.postMessage`.

#### React Components & UI
-   **`Popup.tsx`**: **React Component (UI).** The user interface for the extension's toolbar popup. _Currently empty._
    -   **Usage**: Mounted into `public/popup.html`. Will communicate with `background.ts` to manage settings for the active tab.
-   **`options.tsx`**: **React Component (UI).** The user interface for the extension's options page. _Currently empty._
    -   **Usage**: Mounted into `public/options.html`. Will communicate with `background.ts` to manage global settings and site lists.
-   **`main.tsx`**: **React Entry Point.** The entry point for the main development app (`index.html`). Not used in the final extension build.
-   **`App.tsx`**: **React Component.** The root component for the development app. Not used in the final extension build.

#### Supporting Modules & Assets
-   **`content/styles.ts`**: **CSS Generation.** A module that programmatically generates the CSS string needed to apply the OpenDyslexic font and user-defined styles.
    -   **Key Exports**: `buildCss`
    -   **Usage**: Used by `content-script.ts` to create the stylesheet content.
-   **`lib/storage.ts`**: **Storage Wrapper.** A typesafe API wrapper around `chrome.storage.local` for getting and setting all extension settings.
    -   **Key Exports**: `getSettings`, `setSettings`, `setSiteSetting`
    -   **Usage**: Used primarily by `background.ts`. Relies on types from `types/settings.ts`.
-   **`types/settings.ts`**: **Type Definitions.** Defines the data structures for all global and site-specific settings (`Settings`, `SiteSetting`) and provides the `DEFAULT_SETTINGS` constant.
    -   **Key Exports**: `Settings`, `SiteSetting`, `DEFAULT_SETTINGS`
    -   **Usage**: Used by `background.ts` and `lib/storage.ts` to ensure type-safe state management.
-   **`assets/`**: Contains static assets (like images) that are imported directly into the source code (e.g., within React components).
-   **`index.css` / `App.css`**: **Stylesheets.** CSS files for the development app. Not used in the final extension build.
-   **`vite-env.d.ts`**: **TypeScript Declarations.** Type definitions for Vite-specific environment variables, like `import.meta.env`.

## 3. Conventions & Best Practices

-   **File Naming**:
    -   React components: `PascalCase.tsx` (e.g., `Popup.tsx`).
    -   Other TypeScript files: `camelCase.ts` or `kebab-case.ts` (e.g., `content-script.ts`).
-   **State Immutability**: When updating state (especially in `background.ts`), always create new objects or arrays instead of mutating existing ones (e.g., using the spread syntax `{...oldState, ...patch}`).
-   **Type Safety**:
    -   Use the defined `Message` type in `background.ts` to handle messages with a type-safe discriminated union.
    -   Leverage the `Settings` and `SiteSetting` types from `types/settings.ts` for all storage operations.
-   **Error Handling**: Wrap asynchronous operations in `try...catch` blocks to prevent the extension from crashing and to log meaningful errors.
-   **Performance**:
    -   The `MutationObserver` in the content script uses `requestIdleCallback` to debounce and throttle DOM processing, minimizing its impact on page performance.
    -   CSS selectors are as specific as possible to avoid overly broad matching.
-   **Debugging**: In development mode (`import.meta.env.DEV`), the content script exports key functions to the `window` object for manual testing from the browser's developer console.
